name: VS2022

on: 
  push:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.gitignore'
      - '.gitattributes'
      - 'res/**'
      - '**.cmd'
      - '**.md'
      - '**.rc'
      - '**.sh'
      - '**.txt'
      - '**.xml'
      tags:
      - 'v[0-9]+.[0-9]+'
  pull_request:
    branches: [master]
    paths-ignore:
      - '.gitignore'
      - '.gitattributes'
      - 'res/**'
      - '**.cmd'
      - '**.md'
      - '**.rc'
      - '**.sh'
      - '**.txt'
      - '**.xml'
      

env:
  SOLUTION_FILE_PATH: ./rufus.sln
  BUILD_CONFIGURATION: Release

jobs:
  VS2022-Build:
    runs-on: windows-latest

    strategy:
      matrix:
        TARGET_PLATFORM: [x64, x86, arm64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64
        
    # Assuming the MSBuild step is here and successfully produces rufus.exe
    
    # New step to handle file finalization and compression
    - name: Finalize, Rename and Compress Executable
      id: finalize # <-- Added ID to retrieve outputs
      # The failure was "upx: rufus.exe: FileNotFoundException". This block ensures
      # the executable is moved to the current directory and compressed correctly.
      shell: cmd
      run: |
        rem Path to the built executable from the log: D:\a\rufus\rufus\x64\Release\rufus.exe
        rem Using the build folder relative to the solution file's location.
        set BUILD_DIR=D:\a\rufus\rufus\${{ matrix.TARGET_PLATFORM }}\Release\
        set ORIGINAL_EXE_NAME=rufus.exe
        
        rem 1. Move the built executable to the root of the working directory
        move "%BUILD_DIR%%ORIGINAL_EXE_NAME%" .

        rem 2. Get version number 
        set CURRENT_VERSION=
        for /f %%i in ('git describe --tags --always --long --dirty') do set CURRENT_VERSION=%%i
        set CURRENT_VERSION=%CURRENT_VERSION:v=%
        
        rem 3. Rename the executable to its final versioned name (e.g., rufus-4.4_x64.exe)
        set RENAMED_EXE_NAME=rufus-%CURRENT_VERSION%_${{ matrix.TARGET_PLATFORM }}.exe
        ren "%ORIGINAL_EXE_NAME%" "%RENAMED_EXE_NAME%"
        
        rem Output the renamed file name for use in subsequent YAML steps
        echo RENAMED_EXE_NAME=%RENAMED_EXE_NAME%>>%GITHUB_OUTPUT%

        rem 4. Run UPX compression on the renamed file (for x64/x86). 
        if not ${{ matrix.TARGET_PLATFORM }}==arm64 ( 
          upx --lzma --best "%RENAMED_EXE_NAME%" 
        )
        
        rem 5. Create the simplified name for artifact upload (e.g., rufus_x64.exe)
        rem This file is used in the subsequent SHA-256 and Upload steps.
        copy "%RENAMED_EXE_NAME%" rufus_${{ matrix.TARGET_PLATFORM }}.exe

    - name: Upload Release Asset (On Tag Push)
      # Only runs if the push event is a tag (e.g., refs/tags/v4.4)
      if: ${{ startsWith(github.ref, 'refs/tags/') }}
      # Use PowerShell for GitHub CLI on Windows runner
      shell: pwsh
      run: |
        # Use the GitHub CLI to upload the asset to the release associated with the tag
        gh release upload ${{ github.ref_name }} ./${{ steps.finalize.outputs.RENAMED_EXE_NAME }} --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Required for gh CLI authentication

    - name: Display SHA-256
      run: sha256sum ./rufus_${{ matrix.TARGET_PLATFORM }}.exe

    - name: Upload to VirusTotal
      continue-on-error: true
      if: ${{ github.event_name == 'push' }}
      run: |
        curl --request POST --url https://www.virustotal.com/vtapi/v2/file/scan --form apikey=${{ secrets.VIRUSTOTAL_API_KEY }} --form file=@./rufus_${{ matrix.TARGET_PLATFORM }}.exe
        curl --request POST --url https://www.virustotal.com/api/v3/monitor/items --header 'x-apikey: ${{ secrets.VIRUSTOTAL_API_KEY }}' --form path='/rufus_${{ matrix.TARGET_PLATFORM }}.exe' --form file=@./rufus_${{ matrix.TARGET_PLATFORM }}.exe

    - name: Upload artifacts
      uses: actions/upload-artifact@v5
      if: ${{ github.event_name == 'push' }}
      with:
        name: ${{ matrix.TARGET_PLATFORM }}
        path: |
          ./rufus_${{ matrix.TARGET_PLATFORM }}.exe
          ./rufus.exe