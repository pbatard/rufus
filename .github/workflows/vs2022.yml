name: VS2022

on: 
  push:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
      - '.gitignore'
      - '.gitattributes'
      - 'res/**'
      - '**.cmd'
      - '**.md'
      - '**.rc'
      - '**.sh'
      - '**.txt'
      - '**.xml'
    # Trigger release on tags
    tags:
      - 'v[0-9]+.[0-9]+'
  pull_request:
    branches: [master]
    paths-ignore:
      - '.gitignore'
      - '.gitattributes'
      - 'res/**'
      - '**.cmd'
      - '**.md'
      - '**.rc'
      - '**.sh'
      - '**.txt'
      - '**.xml'
  # Also allow manual runs for testing
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: ./rufus.sln
  BUILD_CONFIGURATION: Release

jobs:
  VS2022-Build:
    runs-on: windows-latest

    strategy:
      matrix:
        TARGET_PLATFORM: [x64, x86, arm64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Get Version Number (from Git Tag)
      id: set_version
      shell: bash
      run: |
        # Get the tag name (e.g., v4.11) and remove the 'v'
        TAG_NAME="${{ github.ref_name }}"
        VERSION="${TAG_NAME#v}"
        
        # Set output for subsequent steps
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build
      shell: cmd
      run: |
        msbuild ${{ env.SOLUTION_FILE_PATH }} /m /p:Configuration=${{ env.BUILD_CONFIGURATION }},Platform=${{ matrix.TARGET_PLATFORM }}
        move .\\res\\${{ matrix.TARGET_PLATFORM }}\\Release\\rufus.exe .\\rufus_${{ matrix.TARGET_PLATFORM }}.exe
        
        # Rename the x64 binary to the generic name, which is common for Rufus
        if ${{ matrix.TARGET_PLATFORM }}==x64 (
          ren rufus_x64.exe rufus.exe
        )
        
        # Apply UPX compression (unless ARM64)
        if not ${{ matrix.TARGET_PLATFORM }}==arm64 (
          if not exist upx.exe ( curl -L https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip -o upx.zip && 7z x upx.zip upx.exe )
          upx.exe --lzma --best rufus.exe
        )

    - name: Display SHA-256
      run: sha256sum ./rufus_${{ matrix.TARGET_PLATFORM }}.exe

    # Note: I'm keeping the VirusTotal checks as they were in the original files
    - name: Upload to VirusTotal
      continue-on-error: true
      if: ${{ github.event_name == 'push' }}
      run: |
        curl --request POST --url https://www.virustotal.com/vtapi/v2/file/scan --form apikey=${{ secrets.VIRUSTOTAL_API_KEY }} --form file=@./rufus_${{ matrix.TARGET_PLATFORM }}.exe
        curl --request POST --url https://www.virustotal.com/api/v3/monitor/items --header 'x-apikey: ${{ secrets.VIRUSTOTAL_API_KEY }}' --form path='/rufus_${{ matrix.TARGET_PLATFORM }}.exe' --form file=@./rufus_${{ matrix.TARGET_PLATFORM }}.exe

    - name: Upload artifacts
      uses: actions/upload-artifact@v5
      if: ${{ github.event_name == 'push' }}
      with:
        # Renaming the x64 artifact to 'rufus-generic' for the release job
        name: ${{ matrix.TARGET_PLATFORM == 'x64' && 'rufus-generic' || matrix.TARGET_PLATFORM }}
        path: |
          ./rufus*.exe
          ./rufus_*.exe

  # New Job: Release Process
  release_files:
    # Only run this if we are pushing a tag
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: VS2022-Build # Must wait for all builds to finish

    steps:
      - name: Get Tag Name
        id: vars
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
      
      - name: Download All Build Artifacts
        uses: actions/download-artifact@v4
        with:
          # Download all artifacts created by the previous job
          path: artifacts

      - name: Prepare Files for Release
        run: |
          # Move all executables to the root directory for zipping
          # Renames them from the artifact name structure to the final release names
          mv artifacts/x86/rufus_x86.exe rufus_32bit.exe
          mv artifacts/arm64/rufus_arm64.exe rufus_arm64.exe
          mv artifacts/rufus-generic/rufus.exe rufus.exe # The generic x64 version

          # List files to confirm
          ls -l
          
          # Zip the main executable
          zip -j rufus.zip rufus.exe

          # Zip the 32bit and arm64 versions for separate downloads
          zip -j rufus_32bit.zip rufus_32bit.exe
          zip -j rufus_arm64.zip rufus_arm64.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Rufus Release ${{ steps.vars.outputs.TAG_NAME }}
          files: |
            rufus.zip
            rufus_32bit.zip
            rufus_arm64.zip
          draft: false
          prerelease: false
          body: |
            ## Automated Release
            
            This release contains the Windows x64 (generic), x86 (32-bit), and ARM64 versions built using the Visual Studio toolchain.
            
            **Included Files:**
            - `rufus.zip` (x64/Default)
            - `rufus_32bit.zip` (x86)
            - `rufus_arm64.zip` (ARM64)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}